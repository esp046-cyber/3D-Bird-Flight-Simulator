<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkySoar: Accessible</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Accessible 3D flight simulator with high contrast mode and reduced motion support.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦…</text></svg>">

    <style>
        /* --- AAA ACCESSIBILITY PALETTE --- */
        :root { 
            --bg-color: #0f172a;
            --ui-bg: rgba(0, 0, 0, 0.85); /* High opacity for text contrast */
            --text-main: #ffffff;
            --highlight: #fbbf24; /* Used for graphics, not text on white */
            --btn-bg: #000000;
            --btn-border: #ffffff;
            --focus-ring: #40e0d0; /* High vis turquoise for focus state */
        }

        body { margin: 0; overflow: hidden; background: var(--bg-color); font-family: 'Verdana', sans-serif; user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; outline: none; }

        /* VISUAL FX */
        body::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.2) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 900;
        }

        /* HUD LAYOUT */
        #hud { 
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px; 
            pointer-events: none; z-index: 10; 
            display: flex; justify-content: space-between; box-sizing: border-box; 
        }
        
        /* HIGH CONTRAST PANELS */
        .panel { 
            pointer-events: auto; 
            background: var(--ui-bg); 
            padding: 20px; 
            border-radius: 8px; 
            border: 2px solid var(--btn-border); 
            color: var(--text-main); 
            display: flex; flex-direction: column; gap: 10px;
            min-width: 200px;
        }
        
        h1 { margin: 0; font-size: 1.8rem; color: #ffffff; letter-spacing: 2px; text-transform: uppercase; }
        
        /* READABLE STATS */
        .stat-row { font-size: 1.2rem; font-weight: bold; font-family: monospace; letter-spacing: 1px; }

        /* ACCESSIBLE BUTTONS */
        button { 
            border: 3px solid var(--btn-border); 
            background: var(--btn-bg); 
            color: var(--text-main); 
            padding: 15px 20px; 
            border-radius: 8px; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            text-transform: uppercase;
            touch-action: manipulation;
        }
        
        /* FOCUS STATES (Critical for Keyboard Nav) */
        button:focus-visible {
            outline: 4px solid var(--focus-ring);
            outline-offset: 4px;
            background: #333;
        }
        button:active { background: #ffffff; color: #000000; }

        .btn-menu { width: 100%; margin-top: 10px; font-size: 1.2rem; }
        .btn-secondary { background: transparent; }

        /* PAUSE MENU */
        #pause-menu { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); /* Nearly opaque for readability */
            z-index: 50; display: none; flex-direction: column; 
            justify-content: center; align-items: center; 
        }
        #pause-menu h2 { color: white; font-size: 4rem; margin-bottom: 30px; text-decoration: underline; text-decoration-color: var(--highlight); }

        /* TOUCH CONTROLS */
        #controls { position: absolute; bottom: 30px; right: 30px; z-index: 20; display: flex; gap: 20px; pointer-events: none; }
        
        .action-btn { 
            pointer-events: auto; width: 90px; height: 90px; border-radius: 50%; 
            background: #000; border: 4px solid #fff; 
            color: #fff; font-weight: 900; display: flex; justify-content: center; align-items: center; 
            font-size: 1rem; box-shadow: 0 0 0 2px #000;
        }
        
        #stamina-wrap { width: 100%; height: 12px; background: #333; margin-top: 5px; border: 2px solid #fff; border-radius: 6px; }
        #stamina-bar { width: 100%; height: 100%; background: #fbbf24; }

        /* UTILITIES */
        .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        /* MOBILE JOYSTICK */
        #joystick-zone { display: none; }
        @media (hover: none) { 
            #joystick-zone { display: block; position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px; border: 4px solid rgba(255,255,255,0.5); border-radius: 50%; pointer-events: auto; }
            #joystick-knob { position: absolute; width: 60px; height: 60px; background: #fff; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid #000; }
        }
    </style>
</head>
<body>

    <div id="pause-menu" role="dialog" aria-labelledby="pause-title" aria-modal="true">
        <h2 id="pause-title">PAUSED</h2>
        <div style="display:flex; flex-direction:column; gap:15px; width: 300px;">
            <button class="btn-menu" id="resume-btn">Resume Game</button>
            <button class="btn-menu btn-secondary" id="world-btn">Change World</button>
            <button class="btn-menu btn-secondary" id="motion-btn" aria-pressed="false">Reduced Motion: OFF</button>
            <button class="btn-menu btn-secondary" id="mute-btn" aria-pressed="false">Mute Audio</button>
        </div>
    </div>

    <div id="hud" aria-hidden="true"> <div class="panel">
            <h1>SKYSOAR</h1>
            <div style="font-size: 0.9rem;">WCAG COMPLIANT</div>
            <div id="stamina-wrap" role="progressbar" aria-label="Stamina" aria-valuenow="100"><div id="stamina-bar"></div></div>
            <div class="stat-row" style="margin-top:10px;">
                ALT: <span id="alt">0</span>m
            </div>
            <div class="stat-row">
                SPD: <span id="spd">0</span>
            </div>
        </div>
        <div class="panel" style="align-items: flex-end;">
            <div style="font-size: 3rem; font-weight: 900;" id="score">0</div>
            <div style="font-size: 1rem; font-weight: bold; text-transform: uppercase;">Score</div>
        </div>
    </div>

    <div id="joystick-zone">
        <div id="joystick-knob"></div>
    </div>
    
    <div id="controls">
        <button class="action-btn" id="pause-trigger" aria-label="Pause Game">PAUSE</button>
        <button class="action-btn" id="dive-btn" aria-label="Dive">DIVE</button>
    </div>

    <canvas id="game-canvas" aria-label="Game View"></canvas>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';

        const BIOMES = [
            { name: "FOREST", sky: 0x87CEEB, fog: 0x87CEEB, ground: 0x2d4c1e, obj: 0x1a2f1a, sun: 0xffffff },
            { name: "CANYON", sky: 0xFF8C00, fog: 0xFF8C00, ground: 0x8B4500, obj: 0x5c2a00, sun: 0xffaa00 },
            { name: "ARCTIC", sky: 0x527190, fog: 0x527190, ground: 0xf1f5f9, obj: 0x94a3b8, sun: 0xffffff },
        ];

        const COUNT = 2500;
        const SIZE = 6000;

        class AudioController {
            constructor() { this.ctx = null; this.gain = null; this.muted = false; }
            init() {
                if (this.ctx) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                const b = this.ctx.createBuffer(1, this.ctx.sampleRate*2, this.ctx.sampleRate);
                const d = b.getChannelData(0);
                for(let i=0; i<d.length; i++) d[i] = (Math.random()*2-1)*0.5;
                const src = this.ctx.createBufferSource(); src.buffer = b; src.loop = true;
                const f = this.ctx.createBiquadFilter(); f.frequency.value = 400;
                this.gain = this.ctx.createGain(); this.gain.value = 0;
                src.connect(f).connect(this.gain).connect(this.ctx.destination);
                src.start();
            }
            update(speed) {
                if(!this.gain || this.muted) return;
                const vol = Math.min(speed/6, 0.2);
                this.gain.gain.setTargetAtTime(vol, this.ctx.currentTime, 0.1);
            }
            toggleMute() {
                this.muted = !this.muted;
                if(this.gain) this.gain.gain.value = this.muted ? 0 : 0.1;
                return this.muted;
            }
            suspend(p) { if(this.ctx) p ? this.ctx.suspend() : this.ctx.resume(); }
        }

        class Game {
            constructor() {
                this.audio = new AudioController();
                this.input = { x:0, y:0, dive:false, sx:0, sy:0 };
                this.state = { speed:0, stamina:100, score:0, paused:false, biome:0, reducedMotion: false };
                this.env = [];
                this.initDOM();
                this.init3D();
            }

            initDOM() {
                const togglePause = () => {
                    this.state.paused = !this.state.paused;
                    const menu = document.getElementById('pause-menu');
                    menu.style.display = this.state.paused ? 'flex' : 'none';
                    this.audio.suspend(this.state.paused);
                    if(this.state.paused) document.getElementById('resume-btn').focus();
                };

                // Event Binding Helper
                const bind = (id, fn) => {
                    const el = document.getElementById(id);
                    if(!el) return;
                    el.addEventListener('click', fn);
                    el.addEventListener('touchstart', (e) => { e.preventDefault(); fn(); }, {passive:false});
                };

                bind('pause-trigger', togglePause);
                bind('resume-btn', togglePause);

                bind('world-btn', () => {
                    this.state.biome = (this.state.biome + 1) % BIOMES.length;
                    this.loadBiome(this.state.biome);
                });

                bind('motion-btn', () => {
                    this.state.reducedMotion = !this.state.reducedMotion;
                    const btn = document.getElementById('motion-btn');
                    btn.innerText = this.state.reducedMotion ? "Reduced Motion: ON" : "Reduced Motion: OFF";
                    btn.setAttribute('aria-pressed', this.state.reducedMotion);
                });

                bind('mute-btn', () => {
                    const isMuted = this.audio.toggleMute();
                    const btn = document.getElementById('mute-btn');
                    btn.innerText = isMuted ? "Unmute Audio" : "Mute Audio";
                    btn.setAttribute('aria-pressed', isMuted);
                });

                // Keyboard Accessibility
                window.addEventListener('keydown', e => {
                    if(e.key === 'Escape') togglePause();
                    if(e.key === 'm' || e.key === 'M') this.audio.toggleMute();
                    if(this.state.paused) return;
                    
                    if(!this.audio.ctx) this.audio.init();
                    if('ArrowUp,w'.includes(e.key)) this.input.y = 1;
                    if('ArrowDown,s'.includes(e.key)) this.input.y = -1;
                    if('ArrowLeft,a'.includes(e.key)) this.input.x = 1;
                    if('ArrowRight,d'.includes(e.key)) this.input.x = -1;
                    if(e.key === 'Shift' || e.key === ' ') this.input.dive = true;
                });
                
                window.addEventListener('keyup', e => {
                    if('ArrowUp,w,s,ArrowDown'.includes(e.key)) this.input.y = 0;
                    if('ArrowLeft,a,d,ArrowRight'.includes(e.key)) this.input.x = 0;
                    if(e.key === 'Shift' || e.key === ' ') this.input.dive = false;
                });

                // Dive Button (Mouse/Touch)
                const dBtn = document.getElementById('dive-btn');
                const startDive = (e) => { 
                    e.preventDefault(); 
                    if(!this.audio.ctx) this.audio.init(); 
                    this.input.dive = true; 
                    dBtn.style.background = "#ffffff"; dBtn.style.color = "#000";
                };
                const endDive = (e) => { 
                    e.preventDefault(); 
                    this.input.dive = false; 
                    dBtn.style.background = "#000000"; dBtn.style.color = "#ffffff";
                };
                dBtn.addEventListener('mousedown', startDive); dBtn.addEventListener('mouseup', endDive); dBtn.addEventListener('mouseleave', endDive);
                dBtn.addEventListener('touchstart', startDive, {passive:false}); dBtn.addEventListener('touchend', endDive, {passive:false});

                // Joystick
                const zone = document.getElementById('joystick-zone');
                const knob = document.getElementById('joystick-knob');
                zone.addEventListener('touchstart', e => {
                    if(this.state.paused) return;
                    this.input.sx = e.touches[0].clientX; this.input.sy = e.touches[0].clientY;
                }, {passive:false});
                zone.addEventListener('touchmove', e => {
                    if(this.state.paused) return;
                    e.preventDefault();
                    const dx = e.touches[0].clientX - this.input.sx;
                    const dy = e.touches[0].clientY - this.input.sy;
                    this.input.x = Math.max(-1, Math.min(1, dx/40));
                    this.input.y = Math.max(-1, Math.min(1, -dy/40));
                    knob.style.transform = `translate(calc(-50% + ${this.input.x*40}px), calc(-50% + ${this.input.y*-40}px))`;
                }, {passive:false});
                zone.addEventListener('touchend', () => { 
                    this.input.x=0; this.input.y=0; 
                    knob.style.transform = `translate(-50%, -50%)`;
                });
            }

            init3D() {
                const cvs = document.getElementById('game-canvas');
                this.renderer = new THREE.WebGLRenderer({ canvas: cvs, antialias: true });
                this.renderer.setSize(innerWidth, innerHeight);
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 6000);
                
                this.hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); this.scene.add(this.hemi);
                this.sun = new THREE.DirectionalLight(0xffffff, 1.5);
                this.sun.position.set(-100, 300, -100); this.scene.add(this.sun);

                this.buildBird();
                this.loadBiome(0);
                
                window.addEventListener('resize', () => {
                    this.camera.aspect = innerWidth/innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(innerWidth, innerHeight);
                });
                this.loop();
            }

            loadBiome(idx) {
                const d = BIOMES[idx];
                this.scene.background = new THREE.Color(d.sky);
                this.scene.fog = new THREE.FogExp2(d.fog, 0.0008);
                this.env.forEach(o => this.scene.remove(o));
                this.env = [];

                const gGeo = new THREE.PlaneGeometry(SIZE, SIZE, 64, 64);
                const ground = new THREE.Mesh(gGeo, new THREE.MeshStandardMaterial({color: d.ground, roughness:1}));
                ground.rotation.x = -Math.PI/2; ground.position.y = -150;
                this.scene.add(ground); this.env.push(ground);

                const tGeo = new THREE.ConeGeometry(20, 80, 5); tGeo.translate(0,40,0);
                const tMat = new THREE.MeshStandardMaterial({color: d.obj});
                const mesh = new THREE.InstancedMesh(tGeo, tMat, COUNT);
                const dummy = new THREE.Object3D();
                for(let i=0; i<COUNT; i++) {
                    dummy.position.set((Math.random()-0.5)*SIZE, -150, (Math.random()-0.5)*SIZE);
                    const s = 1+Math.random()*2; dummy.scale.set(s, s*(0.8+Math.random()), s);
                    dummy.updateMatrix(); mesh.setMatrixAt(i, dummy.matrix);
                }
                this.scene.add(mesh); this.env.push(mesh);
            }

            buildBird() {
                this.bird = new THREE.Group();
                // HIGH VISIBILITY MATERIAL FOR COLORBLIND USERS
                // Using Dark Charcoal (High contrast against light sky)
                const matBody = new THREE.MeshStandardMaterial({color: 0x222222}); 
                const matTip = new THREE.MeshBasicMaterial({color: 0xffffff}); // White tips for visibility
                
                const body = new THREE.Mesh(new THREE.ConeGeometry(0.6, 2, 8), matBody);
                body.rotation.x = -Math.PI/2; this.bird.add(body);
                
                const wGeo = new THREE.BoxGeometry(2.8, 0.1, 1); wGeo.translate(1.4, 0, 0);
                this.wingL = new THREE.Mesh(wGeo, matBody); this.wingL.position.set(0.2, 0.2, -0.3);
                this.wingR = new THREE.Mesh(wGeo, matBody); this.wingR.position.set(-0.2, 0.2, -0.3); this.wingR.scale.x = -1;
                this.bird.add(this.wingL, this.wingR);
                this.scene.add(this.bird);
            }

            loop() {
                requestAnimationFrame(() => this.loop());
                if(this.state.paused) return;
                this.state.time += 0.02;

                if(this.input.dive && this.state.stamina>0) this.state.stamina -= 0.5;
                else if(!this.input.dive) this.state.stamina = Math.min(100, this.state.stamina+0.15);
                
                let tSpeed = (this.input.dive && this.state.stamina>0) ? 5.0 : (this.input.y>0 ? 2.5 : 1.2);
                this.state.speed += (tSpeed - this.state.speed) * 0.05;

                this.bird.translateZ(-this.state.speed);
                this.bird.rotation.z += (this.input.x*-0.8 - this.bird.rotation.z) * 0.1;
                this.bird.rotation.x += ((this.input.dive?-0.6:this.input.y*0.5) - this.bird.rotation.x) * 0.1;
                this.bird.rotation.y += this.bird.rotation.z * 0.04;

                // Camera Logic (Respects Reduced Motion Preference)
                const lerpSpeed = this.state.reducedMotion ? 1.0 : 0.1; // Instant follow if motion reduced
                const cOff = new THREE.Vector3(0, 7, 18 + (this.state.reducedMotion ? 0 : this.state.speed*2));
                cOff.applyMatrix4(this.bird.matrixWorld);
                this.camera.position.lerp(cOff, lerpSpeed);
                this.camera.lookAt(this.bird.position);

                const flap = Math.sin(this.state.time * 10) * 0.5;
                this.wingL.rotation.z = this.input.dive ? -0.5 : flap;
                this.wingR.rotation.z = this.input.dive ? 0.5 : -flap;

                if(this.bird.position.length() > SIZE/2) {
                    this.bird.position.set(0, 150, 0); this.camera.position.set(0, 150, 20);
                }

                document.getElementById('stamina-bar').style.width = this.state.stamina + '%';
                document.getElementById('spd').innerText = Math.floor(this.state.speed*50);
                document.getElementById('alt').innerText = Math.floor(this.bird.position.y+150);
                document.getElementById('score').innerText = Math.floor(this.state.time * 10);
                this.audio.update(this.state.speed);
                this.renderer.render(this.scene, this.camera);
            }
        }

        window.onload = () => new Game();
    </script>
</body>
</html>