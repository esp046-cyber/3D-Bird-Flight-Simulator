<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkySoar: Definitive Edition</title>
    <meta name="theme-color" content="#0f172a">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦…</text></svg>">
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22SkySoar%22%2C%22short_name%22%3A%22SkySoar%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230f172a%22%2C%22theme_color%22%3A%22%230f172a%22%7D">

    <style>
        /* --- 1. CORE STYLES --- */
        :root { --primary: #fbbf24; --glass: rgba(15, 23, 42, 0.85); --text: #ffffff; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; outline: none; }

        /* --- 2. VISUAL FX --- */
        body::after { /* Scanlines */
            content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 900;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 3px;
        }
        body::before { /* Vignette */
            content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 800;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.7);
        }

        /* --- 3. HUD --- */
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; pointer-events: none; z-index: 10; display: flex; justify-content: space-between; box-sizing: border-box; }
        
        .panel { 
            pointer-events: auto; background: var(--glass); backdrop-filter: blur(12px);
            padding: 15px 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); 
            color: var(--text); box-shadow: 0 8px 32px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 5px;
            min-width: 200px;
        }
        
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-style: italic; font-weight: 900; letter-spacing: 2px; text-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .label { font-size: 0.7rem; font-weight: bold; opacity: 0.8; letter-spacing: 1px; }
        
        #score { font-size: 2.5rem; font-weight: 900; line-height: 1; }
        .stats { display: flex; justify-content: space-between; margin-top: 10px; font-family: monospace; font-size: 0.9rem; }
        .stats b { color: var(--primary); }

        #stamina-wrap { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        #stamina-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #f59e0b, #fbbf24); transition: width 0.1s; }

        /* --- 4. MENUS (Pause & Leaderboard) --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; backdrop-filter: blur(5px);
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        
        h2 { color: white; font-size: 3rem; margin-bottom: 30px; font-weight: 900; letter-spacing: 5px; }
        
        button { border: none; outline: none; cursor: pointer; font-family: inherit; }
        .btn-menu {
            background: var(--primary); color: black; padding: 15px 40px; border-radius: 30px;
            font-size: 1.1rem; font-weight: bold; width: 280px; margin-top: 15px; transition: transform 0.1s;
        }
        .btn-menu:active { transform: scale(0.95); }
        .btn-secondary { background: transparent; border: 2px solid white; color: white; }

        /* Leaderboard List */
        .board-panel { text-align: center; width: 320px; }
        #score-list { list-style: none; padding: 0; margin: 20px 0; text-align: left; width: 100%; }
        #score-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace; font-size: 1.1rem; }

        /* --- 5. CONTROLS --- */
        #controls { position: absolute; bottom: 30px; right: 30px; z-index: 20; display: flex; gap: 20px; pointer-events: none; }
        
        .action-btn { 
            pointer-events: auto; width: 90px; height: 90px; border-radius: 50%; 
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); 
            color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; 
            font-size: 0.8rem; backdrop-filter: blur(4px); transition: all 0.1s;
        }
        .action-btn:active { background: var(--primary); color: black; border-color: var(--primary); transform: scale(0.9); }
        
        #dive-btn { border-color: var(--primary); color: var(--primary); }
        #dive-btn:active { background: var(--primary); color: black; }

        /* Joystick */
        #joystick-zone { display: none; }
        @media (hover: none) { 
            #joystick-zone { display: block; position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px; border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
            #joystick-knob { position: absolute; width: 60px; height: 60px; background: rgba(255,255,255,0.4); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid white; }
        }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="leaderboard-modal" class="modal">
        <div class="panel board-panel">
            <h2 style="font-size: 2rem; margin-bottom: 10px;">TOP PILOTS</h2>
            <ul id="score-list">
                <li><span>LOADING...</span></li>
            </ul>
            <button class="btn-menu btn-secondary" id="close-board-btn">CLOSE</button>
        </div>
    </div>

    <div id="pause-menu" class="modal">
        <h2>PAUSED</h2>
        <button class="btn-menu" id="resume-btn">RESUME FLIGHT</button>
        <button class="btn-menu btn-secondary" id="world-btn">CHANGE BIOME</button>
        <button class="btn-menu btn-secondary" id="board-btn">LEADERBOARD</button>
        <div style="color:white; margin-top:20px; opacity:0.6">LOC: <span id="world-name">FOREST</span></div>
    </div>

    <div id="hud">
        <div class="panel">
            <h1>SKYSOAR</h1>
            <div id="stamina-wrap"><div id="stamina-bar"></div></div>
            <div class="stats">
                <span>ALT: <b id="alt">0</b>m</span>
                <span>SPD: <b id="spd">0</b></span>
            </div>
        </div>
        <div class="panel" style="align-items: flex-end;">
            <div id="score">0</div>
            <div class="label">SCORE</div>
        </div>
    </div>

    <div id="joystick-zone"><div id="joystick-knob"></div></div>
    <div id="controls">
        <button class="action-btn" id="pause-trigger">PAUSE</button>
        <button class="action-btn" id="dive-btn">DIVE</button>
    </div>

    <canvas id="game-canvas"></canvas>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';

        // --- 1. DATA & CONFIG ---
        const BIOMES = [
            { name: "ALPINE FOREST", type: 'tree', sky: 0x87CEEB, fog: 0x87CEEB, ground: 0x2d4c1e, obj: 0x1a2f1a, sun: 0xffffff },
            { name: "RED CANYON", type: 'rock', sky: 0xFF8C00, fog: 0xFF8C00, ground: 0x8B4500, obj: 0x5c2a00, sun: 0xffaa00 },
            { name: "ARCTIC SPIKES", type: 'spike', sky: 0x527190, fog: 0x527190, ground: 0xf1f5f9, obj: 0x94a3b8, sun: 0xffffff },
            { name: "NEON CITY", type: 'city', sky: 0x050510, fog: 0x050510, ground: 0x110022, obj: 0x00ffff, sun: 0xff00ff }
        ];
        const TREE_COUNT = 3000;
        const WORLD_SIZE = 6000;

        // --- 2. SYSTEMS ---
        class Leaderboard {
            constructor() { this.key = 'skysoar_scores'; }
            save(score) {
                if(score < 10) return;
                let data = JSON.parse(localStorage.getItem(this.key) || '[]');
                data.push({ date: new Date().toLocaleDateString(), val: Math.floor(score) });
                data.sort((a, b) => b.val - a.val);
                localStorage.setItem(this.key, JSON.stringify(data.slice(0, 5)));
            }
            render() {
                const list = document.getElementById('score-list');
                const data = JSON.parse(localStorage.getItem(this.key) || '[]');
                list.innerHTML = data.length 
                    ? data.map(s => `<li><span>${s.date}</span> <span>${s.val}</span></li>`).join('')
                    : '<li><span>NO RECORDS YET</span></li>';
            }
        }

        class AudioController {
            constructor() { this.ctx = null; this.gain = null; }
            init() {
                if(this.ctx) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                const b = this.ctx.createBuffer(1, this.ctx.sampleRate*2, this.ctx.sampleRate);
                const d = b.getChannelData(0);
                for(let i=0; i<d.length; i++) d[i] = (Math.random()*2-1)*0.5;
                const src = this.ctx.createBufferSource(); src.buffer = b; src.loop = true;
                const f = this.ctx.createBiquadFilter(); f.frequency.value = 400;
                this.gain = this.ctx.createGain(); this.gain.value = 0;
                src.connect(f).connect(this.gain).connect(this.ctx.destination);
                src.start();
            }
            update(speed) {
                if(!this.gain) return;
                this.gain.gain.setTargetAtTime(Math.min(speed/5, 0.25), this.ctx.currentTime, 0.1);
            }
            suspend(p) { if(this.ctx) p ? this.ctx.suspend() : this.ctx.resume(); }
        }

        // --- 3. GAME ENGINE ---
        class Game {
            constructor() {
                this.audio = new AudioController();
                this.leaderboard = new Leaderboard();
                this.input = { x:0, y:0, dive:false, sx:0, sy:0 };
                this.state = { speed:0, stamina:100, score:0, paused:false, biome:0 };
                this.env = [];
                this.wings = [];
                
                this.initDOM();
                this.init3D();
            }

            initDOM() {
                const setPause = (p) => {
                    this.state.paused = p;
                    const pm = document.getElementById('pause-menu');
                    if(p) { pm.classList.add('active'); this.leaderboard.save(this.state.score); }
                    else { pm.classList.remove('active'); }
                    this.audio.suspend(p);
                };

                // Buttons
                const click = (id, fn) => {
                    const el = document.getElementById(id);
                    el.addEventListener('click', fn);
                    el.addEventListener('touchstart', (e)=>{e.preventDefault(); fn();}, {passive:false});
                };

                click('pause-trigger', () => setPause(true));
                click('resume-btn', () => setPause(false));
                click('world-btn', () => {
                    this.state.biome = (this.state.biome + 1) % BIOMES.length;
                    this.loadBiome(this.state.biome);
                });
                click('board-btn', () => {
                    document.getElementById('leaderboard-modal').classList.add('active');
                    this.leaderboard.render();
                });
                click('close-board-btn', () => {
                    document.getElementById('leaderboard-modal').classList.remove('active');
                });

                // Controls
                const dBtn = document.getElementById('dive-btn');
                const setDive = (v) => { 
                    if(!this.audio.ctx) this.audio.init();
                    this.input.dive = v; 
                    dBtn.style.background = v ? "var(--primary)" : "";
                    dBtn.style.color = v ? "black" : "";
                };
                ['mousedown','touchstart'].forEach(e=>dBtn.addEventListener(e, (ev)=>{ev.preventDefault(); setDive(true);}));
                ['mouseup','touchend','mouseleave'].forEach(e=>dBtn.addEventListener(e, (ev)=>{ev.preventDefault(); setDive(false);}));

                const zone = document.getElementById('joystick-zone');
                const knob = document.getElementById('joystick-knob');
                zone.addEventListener('touchstart', e => {
                    if(!this.audio.ctx) this.audio.init();
                    this.input.sx = e.touches[0].clientX; this.input.sy = e.touches[0].clientY;
                }, {passive:false});
                zone.addEventListener('touchmove', e => {
                    e.preventDefault();
                    const dx = e.touches[0].clientX - this.input.sx;
                    const dy = e.touches[0].clientY - this.input.sy;
                    this.input.x = Math.max(-1, Math.min(1, dx/40));
                    this.input.y = Math.max(-1, Math.min(1, -dy/40));
                    knob.style.transform = `translate(calc(-50% + ${this.input.x*40}px), calc(-50% + ${this.input.y*-40}px))`;
                }, {passive:false});
                zone.addEventListener('touchend', () => { this.input.x=0; this.input.y=0; knob.style.transform=`translate(-50%,-50%)`;});

                window.addEventListener('keydown', e => {
                    if(e.key==='Escape') setPause(!this.state.paused);
                    if('ArrowUp,w'.includes(e.key)) this.input.y=1;
                    if('ArrowDown,s'.includes(e.key)) this.input.y=-1;
                    if('ArrowLeft,a'.includes(e.key)) this.input.x=1;
                    if('ArrowRight,d'.includes(e.key)) this.input.x=-1;
                    if(e.key==='Shift') setDive(true);
                });
                window.addEventListener('keyup', e => {
                    if('ArrowUp,w,s,ArrowDown'.includes(e.key)) this.input.y=0;
                    if('ArrowLeft,a,d,ArrowRight'.includes(e.key)) this.input.x=0;
                    if(e.key==='Shift') setDive(false);
                });
            }

            init3D() {
                const cvs = document.getElementById('game-canvas');
                this.renderer = new THREE.WebGLRenderer({ canvas: cvs, antialias: true });
                this.renderer.setSize(innerWidth, innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 6000);

                this.hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); this.scene.add(this.hemi);
                this.sun = new THREE.DirectionalLight(0xffffff, 1.5);
                this.sun.position.set(-100, 300, -100); this.sun.castShadow = true;
                this.sun.shadow.mapSize.set(2048, 2048);
                this.sun.shadow.camera.far = 4000;
                const d = 1000;
                this.sun.shadow.camera.left = -d; this.sun.shadow.camera.right = d;
                this.sun.shadow.camera.top = d; this.sun.shadow.camera.bottom = -d;
                this.scene.add(this.sun);

                this.buildBird();
                this.loadBiome(0);
                
                document.getElementById('loader').style.opacity = 0;
                setTimeout(()=>document.getElementById('loader').style.display='none', 500);
                
                window.addEventListener('resize', () => {
                    this.camera.aspect = innerWidth/innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(innerWidth, innerHeight);
                });
                this.loop();
            }

            loadBiome(idx) {
                const d = BIOMES[idx];
                document.getElementById('world-name').innerText = d.name;
                this.scene.background = new THREE.Color(d.sky);
                this.scene.fog = new THREE.FogExp2(d.fog, 0.0008);
                this.sun.color.setHex(d.sun);

                this.env.forEach(o => this.scene.remove(o));
                this.env = [];

                const gGeo = new THREE.PlaneGeometry(SIZE, SIZE, 128, 128);
                const pos = gGeo.attributes.position;
                for(let i=0; i<pos.count; i++) {
                    const x = pos.getX(i); const y = pos.getY(i);
                    const h = d.type==='city' ? 0 : (Math.sin(x/800)*Math.cos(y/800)*150);
                    pos.setZ(i, h);
                }
                gGeo.computeVertexNormals();
                const ground = new THREE.Mesh(gGeo, new THREE.MeshStandardMaterial({color: d.ground, roughness:1}));
                ground.rotation.x = -Math.PI/2; ground.position.y = -150; ground.receiveShadow = true;
                this.scene.add(ground); this.env.push(ground);

                let geo;
                if(d.type === 'tree') { geo = new THREE.ConeGeometry(20, 80, 6); geo.translate(0,40,0); }
                else if(d.type === 'rock') { geo = new THREE.TetrahedronGeometry(60, 0); geo.translate(0,30,0); }
                else if(d.type === 'spike') { geo = new THREE.ConeGeometry(5, 150, 4); geo.translate(0,75,0); }
                else { geo = new THREE.BoxGeometry(40, 200, 40); geo.translate(0,100,0); }

                const mat = new THREE.MeshStandardMaterial({color: d.obj});
                if(d.type==='city') { mat.emissive = new THREE.Color(d.obj); mat.emissiveIntensity = 0.4; }

                const mesh = new THREE.InstancedMesh(geo, mat, COUNT);
                mesh.castShadow = true; mesh.receiveShadow = true;
                const dummy = new THREE.Object3D();
                for(let i=0; i<COUNT; i++) {
                    dummy.position.set((Math.random()-0.5)*SIZE, -150, (Math.random()-0.5)*SIZE);
                    const s = 1+Math.random()*2; dummy.scale.set(s, s*(d.type==='city'?2:1), s);
                    dummy.updateMatrix(); mesh.setMatrixAt(i, dummy.matrix);
                }
                this.scene.add(mesh); this.env.push(mesh);
            }

            buildBird() {
                this.bird = new THREE.Group();
                const matBody = new THREE.MeshStandardMaterial({color: 0x3E2723, roughness: 1.0});
                const matBeak = new THREE.MeshStandardMaterial({color: 0xFFB300, roughness: 0.4});
                const matEye = new THREE.MeshStandardMaterial({color: 0x111111});

                const chest = new THREE.Mesh(new THREE.DodecahedronGeometry(0.6, 2), matBody);
                chest.scale.set(0.8, 0.7, 1.4); chest.castShadow = true; this.bird.add(chest);

                const head = new THREE.Group(); head.position.set(0, 0.4, -0.7);
                head.add(new THREE.Mesh(new THREE.DodecahedronGeometry(0.35, 1), matBody));
                
                const bU = new THREE.Mesh(new THREE.ConeGeometry(0.12, 0.4, 8), matBeak);
                bU.rotation.x = -Math.PI/2 + 0.4; bU.position.set(0, -0.1, -0.35); head.add(bU);
                
                const lEye = new THREE.Mesh(new THREE.SphereGeometry(0.08), matEye); lEye.position.set(0.18, 0.05, -0.15); head.add(lEye);
                const rEye = new THREE.Mesh(new THREE.SphereGeometry(0.08), matEye); rEye.position.set(-0.18, 0.05, -0.15); head.add(rEye);
                this.bird.add(head);

                const createWing = (inv) => {
                    const g = new THREE.Group(); g.position.set(inv?-0.4:0.4, 0.1, 0);
                    const arm = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.1, 0.3), matBody);
                    arm.position.x = inv ? -0.5 : 0.5; arm.castShadow=true; g.add(arm);
                    for(let i=0; i<5; i++) {
                        const f = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.02, 0.8), matBody);
                        f.position.set((inv?-1:1)*(0.2 + i*0.22), 0, 0.3);
                        f.rotation.y = (inv?1:-1) * (0.1 + i*0.1);
                        f.castShadow=true; g.add(f);
                    }
                    return g;
                };
                this.wings = [createWing(false), createWing(true)];
                this.bird.add(this.wings[0], this.wings[1]);
                
                const tail = new THREE.Group(); tail.position.set(0, 0.1, 0.6);
                for(let i=-1; i<=1; i++) {
                    const t = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.02, 0.8), matBody);
                    t.position.set(i*0.15, 0, 0.2); t.rotation.y = i * -0.2; tail.add(t);
                }
                this.bird.add(tail);
                this.scene.add(this.bird);
            }

            loop() {
                requestAnimationFrame(() => this.loop());
                if(this.state.paused) return;
                this.state.time += 0.02;

                if(this.input.dive && this.state.stamina>0) this.state.stamina -= 0.5;
                else if(!this.input.dive) this.state.stamina = Math.min(100, this.state.stamina+0.15);
                
                const isDiving = (this.input.dive && this.state.stamina>0);
                let tSpeed = isDiving ? 5.0 : (this.input.y>0 ? 2.5 : 1.2);
                this.state.speed += (tSpeed - this.state.speed) * 0.05;
                this.state.score += Math.floor(this.state.speed);

                this.bird.translateZ(-this.state.speed);
                this.bird.rotation.z += (this.input.x*-0.8 - this.bird.rotation.z) * 0.1;
                this.bird.rotation.x += ((this.input.dive?-0.6:this.input.y*0.5) - this.bird.rotation.x) * 0.1;
                this.bird.rotation.y += this.bird.rotation.z * 0.04;

                const cOff = new THREE.Vector3(0, 7, 18 + this.state.speed*2);
                cOff.applyMatrix4(this.bird.matrixWorld);
                this.camera.position.lerp(cOff, 0.1);
                this.camera.lookAt(this.bird.position);

                const flap = Math.sin(this.state.time * 15) * 0.5;
                this.wings[0].rotation.z = isDiving ? -0.5 : (flap + 0.2);
                this.wings[1].rotation.z = isDiving ? 0.5 : (-flap - 0.2);

                if(this.bird.position.length() > SIZE/2) {
                    this.bird.position.set(0, 150, 0); this.camera.position.set(0, 150, 20);
                }

                document.getElementById('stamina-bar').style.width = this.state.stamina + '%';
                document.getElementById('spd').innerText = Math.floor(this.state.speed*50);
                document.getElementById('alt').innerText = Math.floor(this.bird.position.y+150);
                document.getElementById('score').innerText = this.state.score;
                
                this.audio.update(this.state.speed);
                this.renderer.render(this.scene, this.camera);
            }
        }

        window.onload = () => new Game();
    </script>
</body>
</html>